#### vue后台系统权限控制与管理

#### 一、权限控制：

​      权限很久以来都是后端控制的，因为web系统本质是围绕数据，但和数据库连接紧密的是后端，所以很长一段时间都是后端控制权限。

​      但是，随着前后端分离架构的流行、越来越多的项目在前端进行权限控制

##### 1.1 权限的分类

##### 后端权限：

​               从本质上讲，前端仅仅是视图层的展示，权限的核心是于服务器中数据的变化，所有后端才是权限的关键。后端权限可以控制某个

​               用户是否能够查询数据、是否能够访问修改数据等操作。



后端如何知道该请求是哪个用户发过来的？  ：  状态保持（不传送用户名和密码的情况下，依然可以知道请求是哪个用户发送过来的）  

​                                                                                 cookie 、 session  、token

后端的权限设计RBAC    ：  基于角色的权限控制

​                                               用户 、角色 、 权限       



##### 前端权限：

​               前端权限的本质： 视图层的展示 、 前端所发送的请求 



##### 1.2 前端权限的意义 

​        降低非法操作的可能性 、排除不必要请求  减少服务器压力 、提高用户体验



### 二、前端权限控制思路      （菜单、界面、按钮、请求和响应控制）

#####          2.1  菜单控制（后台管理系统的侧边栏 ）

#####                              ：登入请求中，得到权限数据、根据权限数据，展示对应的菜单、点击菜单查看相关的页面

#####          2.2 界面控制  

#####                               ; 用户没有登录，手动在地址栏敲入管理界面地址、需要跳转登录界面

#####                              ：用户已经登录，可是手动敲入非权限内地址，需要跳转404界面

#####         2.3  按钮控制

#####                              ：在某个菜单页面中，根据权限数据，展示对应的可操作按钮、比如：增加、修改、删除等

#####        2.4   请求和响应的控制

#####                              ：用户通过非常规操作，比如浏览器调试工具将某些禁用按钮变成启用状态，此时发送的请求，也应该被前端所拦截

 

### 三、vue权限控制的实现

#### 3.1、菜单控制 ：

##### a.登入之后得到  用户权限数据、token、用户信息

##### b.把用户权限数据、toekn、用户信息存放在vuex中、并进行数据持久化存储、方便其他组件使用、

##### c.处理用户权限数据、根据数据渲染侧边栏、  请求拦截器判断token设置请头 ， 导航守卫里判断有没有token，没有就跳回登入页面 、 根据用户信息数据渲染用户相关内容

##### d.点击退出  ：  删除本地存储中的数据、跳转登入页面、刷新当前页面（让vuex重新加载） window.location.reload()



#### 3.2、界面控制

##### a.登入之后，在本地存储保存token   、根据用户具备的权限，动态添加路由规则

##### b.通过路由导航守卫，先判断去去往的路径是不是首页       是       next

#####                                                                                                   不是   =>  判断有没有token   =>  有      next

#####                                                                                                                                                     =>  没有  跳转登入页面  next('/login') 

##### c.根据用户具有的权限，动态添加路由规则 (封装成方法) ： 方法2次调用 ： 登入成功之后调用、在入口文件中created钩子中调用

#####                                       步骤：1.在router.js中把功能路由拿出来           定义4个变量 对应 4个路由对象

#####                                                   2.在router.js中  通过export 倒出一个方法 fun      然后正在login.vue中进行导入方法   方法在登入成功后使用

#####                                                   3.在router.js中引入vuex 、通过vuex拿到 权限数据 

#####                                                       创建一个映射关系对象，key就是权限第二层的路由名称 ， value就是对应路由对象

#####                                                   3. fun方法中

#####                                                    通过vuex先拿到routes数组

#####                                                     对数组进行循环遍历， 映射对象[item.path]  （映射对象 和 二级路由的名称）  、 放到对应路由对象的children中   

#####                                                    const = currentRoutes = router.options.routes;

#####                                                    currentRoutes[2].children.push(   映射对象[item.path]    )

#####                                                     再通过router.addRoutes(  数组名 ) 重新设置给路由对象

#####                                                   4.解决刷新路由消失问题

#####                                                      ：在入口文件中的  created钩子中 ， 调用 fun 方法  （方法就是动态添加路由规则方法）



#### 3.3、按钮控制       ：自定义指令

##### a、在utils目录下创建 permission.js文件 

​                                                                    1、引入Vue 、通过vue.directive('指令名' ，{

​                                                                            inserted(el,binding){

​                                                                               const action = binding.value.action

​                                                                               ·············

​                                                                         }

​                                                                     })



#### 3.4 、请求和响应的控制 : 每一个请求都带上请求头、发出非权限内请求（阻止）

##### a.在请求拦截器中，判断是否有token , 有就统一设置请求头

#####                                                                   req.headers.Authorization = token;

##### b.非权限范围内的请求

#####                                   1.创建映射对象     例：{ ‘get’:'view' ··· }

#####                                   2.const action = 映射对象[req.method]

#####                                  3.const currentRight = router.currentRoute.meta

#####                                 4. 判断 if( currentRight && currentRight.indexOf(action) === -1 )                                 

#####                                    rouer.currentRoute.meta                   (当前路由规则的元数据： 权限数据 )

##### c.响应控制（token过期、篡改）

##### ：判断状态码是不是等于401  =>    是  => 跳转首页、清空本地存储、刷新页面





#### 总结：

##### 1.菜单控制：  权限数据需要多组件共享，需要vux

#####                          防止页面刷新权限数据丢失，同时存在本地存储中

##### 2.界面控制：  路由导航守卫防止跳过登录界面

#####                         动态绑定路由、解决无权限访问

##### 3.按钮控制： 路由规则中增加元数据meta ( 存储权限数据 )

#####                        通过路由对象获取当前路由规则和权限数据

#####                        自定义指令方便按钮控制

##### 4.请求响应控制： 请求拦截器设置请求头、非法请求

#####                                响应烂机器解决token过去与被篡改



#### 登入逻辑：

逻辑：
a.  存储token: 验证用户登入，验证成功发送请求 => 请求成功  => 把token存储在vuex 和 本地存储中  => 跳转首页面
                                             => 请求失败  => 提示错误信息
b.  处理路由：  设置路由元素信息  控制是否需要验证  （meta , 通过meta设置是否需要验证 token ） 
              导航守卫判断验证  要验证  判断有没有token  有token    =>  next() 下一步 
                                                   没有token  =>  跳转登入页面 （通过next跳转，传参 query:{ redirect: to.fullpath }）
                                   不要验证    next()  下一步
                                   
c.  设置请求头  请求拦截器中   判断有没有token    有token   =>   设置请求头  config.headers.Authorization = token ; 

1.通过element-ui 中的 form搭建登入页面、修改样式
2.点击登入，验证 => 请求 =>   成功   =>  把token保存到vuex中  并进行本地存储   => 跳转首页
                           失败   =>  提示信息
3.处理路由 与 设置请求头 



#### 后台权限控制：

##### 权限分配就是登入之后，会从后台那边拿到权限数据，然后进行相关的处理操作。

##### 主要从一下四点入手：

##### 1.菜单控制  ： 根据权限数据，渲染菜单（侧边栏）   vuex  持久化存储

##### 2.界面控制：   设置导航守卫、根据权限数据动态绑定路由

##### 3.按钮控制：   根据权限数据，来展示或隐藏对应的按钮

##### 4.请求响应控制： 登入成功设置请求头 、响应拦截器判断code码token过期